import "../../justfile"

balancebot-dump-text-logs:
	#!/usr/bin/env bash
	set -euo pipefail
	cargo run --bin balancebot-logreader --profile screaming -- logs/balance.copper extract-text-log ../../target/debug/cu29_log_index/strings.bin

balancebot-fsck:
	#!/usr/bin/env bash
	set -euo pipefail
	cargo run --bin balancebot-logreader --profile screaming -- logs/balance.copper fsck

balancebot-set-pwm-permissions:
	#!/usr/bin/env bash
	set -euo pipefail
	for pwm in /sys/class/pwm/pwmchip0/pwm*/; do
		chmod 0660 "${pwm}enable"
		chmod 0660 "${pwm}duty_cycle"
		chmod 0660 "${pwm}period"
		chmod 0660 "${pwm}polarity"
		chown root:wheel "${pwm}enable"
		chown root:wheel "${pwm}duty_cycle"
		chown root:wheel "${pwm}period"
		chown root:wheel "${pwm}polarity"
	done
	chmod 0660 /sys/class/pwm/pwmchip0/unexport
	chown root:wheel /sys/class/pwm/pwmchip0/unexport

mcap:
	#!/usr/bin/env bash
	set -euo pipefail

	copper_base="logs/balance.copper"
	mcap_file="logs/balance.mcap"

	echo "=========================================="
	echo "Converting: ${copper_base} -> ${mcap_file}"
	echo "=========================================="

	# Export to MCAP (Copper will automatically find all _0, _1, _2... slabs)
	cargo run --bin balancebot-logreader --profile screaming -- "${copper_base}" export-mcap --output "${mcap_file}"

	echo ""
	echo "=========================================="
	echo "MCAP Info for: ${mcap_file}"
	echo "=========================================="

	# Run mcap-info to show the user what was created
	cargo run --bin balancebot-logreader --profile screaming -- "${copper_base}" mcap-info "${mcap_file}"
