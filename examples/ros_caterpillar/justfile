import "../../justfile"

ros-caterpillar-run:
	#!/usr/bin/env bash
	set -euo pipefail
	spdlog_dir="{{invocation_directory()}}/.deps/lib"
	mkdir -p "$spdlog_dir"
	if [[ ! -e "$spdlog_dir/libspdlog.so.1.16" ]]; then
		ln -sf /usr/lib/libspdlog.so.1.17 "$spdlog_dir/libspdlog.so.1.16"
	fi
	export LD_LIBRARY_PATH="$spdlog_dir:${LD_LIBRARY_PATH:-}"
	export LIBRARY_PATH="$spdlog_dir:${LIBRARY_PATH:-}"
	rm -rf build/ install/ log/
	if [[ -z "${AMENT_PREFIX_PATH:-}" ]]; then
		if [[ -f "/opt/ros/jazzy/setup.bash" ]]; then
			set +u
			source "/opt/ros/jazzy/setup.bash"
			set -u
		else
			echo "ROS Jazzy environment not found. Source /opt/ros/jazzy/setup.bash before running." >&2
			exit 1
		fi
	fi
	colcon build
	set +u
	source install/setup.bash
	set -u
	export ROS_DOMAIN_ID=42
	echo "Starting all nodes..."
	ros2 run gpio_caterpillar stats_node &
	ros2 run gpio_caterpillar propagate_node gpio_node_1 flip_topic_1 flip_topic_2 &
	ros2 run gpio_caterpillar actuation_node gpio_node_1 4 &
	ros2 run gpio_caterpillar propagate_node gpio_node_2 flip_topic_2 flip_topic_3 &
	ros2 run gpio_caterpillar actuation_node gpio_node_2 17 &
	ros2 run gpio_caterpillar propagate_node gpio_node_3 flip_topic_3 flip_topic_4 &
	ros2 run gpio_caterpillar actuation_node gpio_node_3 27 &
	ros2 run gpio_caterpillar propagate_node gpio_node_4 flip_topic_4 flip_topic_5 &
	ros2 run gpio_caterpillar actuation_node gpio_node_4 22 &
	ros2 run gpio_caterpillar propagate_node gpio_node_5 flip_topic_5 flip_topic_6 &
	ros2 run gpio_caterpillar actuation_node gpio_node_5 5 &
	ros2 run gpio_caterpillar propagate_node gpio_node_6 flip_topic_6 flip_topic_7 &
	ros2 run gpio_caterpillar actuation_node gpio_node_6 6 &
	ros2 run gpio_caterpillar propagate_node gpio_node_7 flip_topic_7 flip_topic_8 &
	ros2 run gpio_caterpillar actuation_node gpio_node_7 19 &
	ros2 run gpio_caterpillar propagate_node gpio_node_8 flip_topic_8 flip_topic_9 &
	ros2 run gpio_caterpillar actuation_node gpio_node_8 26 &
	sleep 2
	ros2 run gpio_caterpillar flip_node &
	echo "All nodes started"
	wait
