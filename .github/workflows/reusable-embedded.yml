name: Reusable Embedded CI

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
      cargo_target_dir:
        required: false
        type: string
        default: ""

jobs:
  nostd:
    name: Core no-std
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - uses: ./.github/actions/embedded-rust-setup
        with:
          toolchain: ${{ inputs.toolchain }}
          cargo_target_dir: ${{ inputs.cargo_target_dir }}

      - name: Install latest nextest
        uses: taiki-e/install-action@nextest
      - name: Check compilation of core with no-std
        run: cargo +${{ inputs.toolchain }} build --no-default-features
      - name: Unit tests of core with no-std
        run: cargo +${{ inputs.toolchain }} nextest run --no-default-features

  embedded-crates:
    name: Embedded crates
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - uses: ./.github/actions/embedded-rust-setup
        with:
          toolchain: ${{ inputs.toolchain }}
          cargo_target_dir: ${{ inputs.cargo_target_dir }}

      - name: Clippy embedded-only crates
        run: python3 support/ci/embedded_crates.py run --action clippy --toolchain ${{ inputs.toolchain }}
      - name: Build embedded-only crates
        run: python3 support/ci/embedded_crates.py run --action build --toolchain ${{ inputs.toolchain }}

  rp2350:
    name: RP2350 skeleton
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - uses: ./.github/actions/embedded-rust-setup
        with:
          toolchain: ${{ inputs.toolchain }}
          cargo_target_dir: ${{ inputs.cargo_target_dir }}

      - name: Clippy an rp2350 example
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} clippy
      - name: Cross compile an rp2350 example with Arm
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} build-arm
      - name: Compile the logreader for the rp2350 example (host)
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} build-logreader
