name: Reusable Embedded CI

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
      cargo_target_dir:
        required: false
        type: string
        default: ""

jobs:
  nostd:
    name: Core no-std
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/embedded-rust-setup
        with:
          toolchain: ${{ inputs.toolchain }}
          cargo_target_dir: ${{ inputs.cargo_target_dir }}

      - name: Install latest nextest
        uses: taiki-e/install-action@nextest
      - name: Check compilation of core with no-std
        run: cargo +${{ inputs.toolchain }} build --no-default-features
      - name: Unit tests of core with no-std
        run: cargo +${{ inputs.toolchain }} nextest run --no-default-features

  embedded-crates:
    name: Embedded crates
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/embedded-rust-setup
        with:
          toolchain: ${{ inputs.toolchain }}
          cargo_target_dir: ${{ inputs.cargo_target_dir }}

      - name: Clippy embedded-only crates
        run: python3 support/ci/embedded_crates.py run --action clippy --toolchain ${{ inputs.toolchain }}
      - name: Build embedded-only crates
        run: python3 support/ci/embedded_crates.py run --action build --toolchain ${{ inputs.toolchain }}

  rp2350:
    name: RP2350 skeleton
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/embedded-rust-setup
        with:
          toolchain: ${{ inputs.toolchain }}
          cargo_target_dir: ${{ inputs.cargo_target_dir }}

      - name: Detect host target
        run: echo "HOST_TARGET=$(rustc +${{ inputs.toolchain }} -vV | sed -n 's/^host: //p')" >> $GITHUB_ENV

      - name: Clippy firmware (RP2350)
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} clippy --target thumbv8m.main-none-eabihf --bin cu-blinky --features firmware
      - name: Clippy host bins (RP2350)
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} clippy --no-default-features --features host --bins --target ${HOST_TARGET}
      - name: Cross compile an rp2350 example with Arm
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} build-arm
      - name: Build logreader (RP2350 host)
        working-directory: examples/cu_rp2350_skeleton
        run: cargo +${{ inputs.toolchain }} build --no-default-features --features host --bin blinky-logreader --target ${HOST_TARGET}
